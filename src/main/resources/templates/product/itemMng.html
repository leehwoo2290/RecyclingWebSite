<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<meta charset="UTF-8">

<!-- CSRF 메타 태그 추가 -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>


<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
  <style>
    select{
      margin-right:10px;
    }

    .delete-controls {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-sm {
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
    }

    .table td {
      vertical-align: middle;
    }

    .item-id {
      font-weight: bold;
      color: #333;
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-sell {
      background-color: #d4edda;
      color: #155724;
    }

    .status-sold-out {
      background-color: #f8d7da;
      color: #721c24;
    }

    #deleteBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #deleteBtn:not(:disabled) {
      cursor: pointer;
    }

    .item-checkbox:checked {
      outline: 2px solid red;
    }

    #deleteBtn.btn-danger {
      background-color: #dc3545 !important;
      border-color: #dc3545 !important;
    }
  </style>
</th:block>

  <body>

<div layout:fragment="content">
  <form th:action="@{'/admin/items/' + ${items.number}}" role="form" method="get" th:object="${items}">
    <!-- 삭제 제어 영역 -->
    <div class="delete-controls">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <button type="button" id="deleteBtn" class="btn btn-secondary" disabled>
            <i class="fas fa-trash"></i> 선택 항목 삭제
          </button>
          <span class="ml-2 text-muted">선택된 상품을 삭제할 수 있습니다.</span>
        </div>
        <div class="text-muted">
          총 <span th:text="${items.totalElements}">0</span>개의 상품
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="thead-light">
        <tr>
          <th width="50">
            <input type="checkbox" id="selectAll" title="전체 선택">
          </th>
          <th width="100">상품ID</th>
          <th>상품명</th>
          <th width="100">상태</th>
          <th width="120">등록자</th>
          <th width="150">등록일</th>
          <th width="120">관리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item, status: ${items.getContent()}">
          <td>
            <input type="checkbox" class="item-checkbox" th:value="${item.id}">
          </td>
          <td>
            <span class="item-id" th:text="${item.id}"></span>
          </td>
          <td>
            <a th:href="'/admin/item/'+${item.id}" th:text="${item.itemNm}"
               class="text-decoration-none"></a>
          </td>
          <td>
                        <span class="status-badge"
                              th:classappend="${item.itemSellStatus.name() == 'SELL'} ? 'status-sell' : 'status-sold-out'"
                              th:text="${item.itemSellStatus.name() == 'SELL'} ? '판매중' : '품절'"></span>
          </td>
          <td th:text="${item.createdBy}"></td>
          <td th:text="${#temporals.format(item.regTime, 'yyyy-MM-dd HH:mm')}"></td>
          <td>
            <div class="action-buttons">
              <button type="button" class="btn btn-outline-primary btn-sm edit-item-btn"
                      th:data-item-id="${item.id}" title="수정">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="btn btn-outline-danger btn-sm delete-item-btn"
                      th:data-item-id="${item.id}"
                      th:data-item-name="${item.itemNm}" title="삭제">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 페이지네이션 -->
    <div th:with="start=${(items.number/maxPage)*maxPage + 1}, end=(${(items.totalPages == 0) ? 1 : (start + (maxPage - 1) < items.totalPages ? start + (maxPage - 1) : items.totalPages)})" >
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${items.first}?'disabled'">
          <a th:onclick="'javascript:page(' + ${items.number - 1} + ')'" aria-label='Previous' class="page-link">
            <span aria-hidden='true'>Previous</span>
          </a>
        </li>

        <li class="page-item" th:each="page: ${#numbers.sequence(start, end)}" th:classappend="${items.number eq page-1}?'active':''">
          <a th:onclick="'javascript:page(' + ${page - 1} + ')'" th:inline="text" class="page-link">[[${page}]]</a>
        </li>

        <li class="page-item" th:classappend="${items.last}?'disabled'">
          <a th:onclick="'javascript:page(' + ${items.number + 1} + ')'" aria-label='Next' class="page-link">
            <span aria-hidden='true'>Next</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- 검색 영역 -->
    <div class="form-inline justify-content-center mt-4" th:object="${itemSearchDto}">
      <select th:field="*{searchDateType}" class="form-control" style="width:auto;">
        <option value="all">전체기간</option>
        <option value="1d">1일</option>
        <option value="1w">1주</option>
        <option value="1m">1개월</option>
        <option value="6m">6개월</option>
      </select>
      <select th:field="*{searchSellStatus}" class="form-control" style="width:auto;">
        <option value="">판매상태(전체)</option>
        <option value="SELL">판매</option>
        <option value="SOLD_OUT">품절</option>
      </select>
      <select th:field="*{searchBy}" class="form-control" style="width:auto;">
        <option value="itemNm">상품명</option>
        <option value="createdBy">등록자</option>
      </select>
      <input th:field="*{searchQuery}" type="text" class="form-control" placeholder="검색어를 입력해주세요">
      <button id="searchBtn" type="submit" class="btn btn-primary">검색</button>
    </div>
  </form>
</div>

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">
  <script th:inline="javascript">
    // jQuery가 로드되었는지 확인하고 없으면 로드
    if (typeof jQuery === 'undefined') {
      var script = document.createElement('script');
      script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
      script.onload = function() {
        initItemManagement();
      };
      document.head.appendChild(script);
    } else {
      $(document).ready(function() {
        initItemManagement();
      });
    }

    function initItemManagement() {
      // 삭제 버튼 상태 업데이트 함수
      function updateDeleteButtonState() {
        var checkedCount = $(".item-checkbox:checked").length;
        if (checkedCount > 0) {
          $("#deleteBtn").prop("disabled", false).removeClass("btn-secondary").addClass("btn-danger");
        } else {
          $("#deleteBtn").prop("disabled", true).removeClass("btn-danger").addClass("btn-secondary");
        }
      }

      // 전체 선택 체크박스 상태 업데이트
      function updateSelectAllState() {
        var totalCheckboxes = $(".item-checkbox").length;
        var checkedCheckboxes = $(".item-checkbox:checked").length;

        if (checkedCheckboxes === 0) {
          $("#selectAll").prop("indeterminate", false).prop("checked", false);
        } else if (checkedCheckboxes === totalCheckboxes) {
          $("#selectAll").prop("indeterminate", false).prop("checked", true);
        } else {
          $("#selectAll").prop("indeterminate", true);
        }
      }

      // 선택된 상품들 삭제
      function deleteSelectedItems() {
        var selectedItems = [];
        $(".item-checkbox:checked").each(function() {
          selectedItems.push($(this).val());
        });

        if (selectedItems.length === 0) {
          alert("삭제할 상품을 선택해주세요.");
          return;
        }

        if (!confirm("선택된 " + selectedItems.length + "개의 상품을 삭제하시겠습니까?")) {
          return;
        }

        // CSRF 토큰 가져오기
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        if (!token) {
          token = $("meta[name='_csrf'][content]").attr("content");
        }
        if (!header) {
          header = $("meta[name='_csrf_header'][content]").attr("content");
        }

        var requestData = {
          'itemIds': selectedItems
        };

        $.ajax({
          url: "/admin/items",
          type: "DELETE",
          data: $.param(requestData, true),
          contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
          beforeSend: function(xhr) {
            if (header && token) {
              xhr.setRequestHeader(header, token);
            }
          },
          success: function(response) {
            alert("선택된 상품이 성공적으로 삭제되었습니다.");
            location.reload();
          },
          error: function(xhr, status, error) {
            var errorMessage = "삭제 중 오류가 발생했습니다.";

            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            } else if (xhr.responseText) {
              errorMessage = xhr.responseText;
            } else {
              errorMessage = errorMessage + " (" + error + ")";
            }

            alert(errorMessage);
          }
        });
      }

      // 이벤트 바인딩
      // 검색 버튼 이벤트
      $(document).off("click", "#searchBtn").on("click", "#searchBtn", function(e) {
        e.preventDefault();
        page(0);
      });

      // 전체 선택/해제
      $(document).off("change", "#selectAll").on("change", "#selectAll", function() {
        var isChecked = $(this).prop("checked");
        $(".item-checkbox").prop("checked", isChecked);
        updateDeleteButtonState();
      });

      // 개별 체크박스 상태 변경
      $(document).off("change", ".item-checkbox").on("change", ".item-checkbox", function() {
        updateDeleteButtonState();
        updateSelectAllState();
      });

      // 선택 항목 삭제 버튼 클릭
      $(document).off("click", "#deleteBtn").on("click", "#deleteBtn", function(e) {
        e.preventDefault();
        if (!$(this).prop("disabled")) {
          deleteSelectedItems();
        }
      });

      // 개별 상품 수정 버튼 클릭
      $(document).off("click", ".edit-item-btn").on("click", ".edit-item-btn", function() {
        var itemId = $(this).data("item-id");
        location.href = "/admin/item/" + itemId;
      });

      // 개별 상품 삭제 버튼 클릭
      $(document).off("click", ".delete-item-btn").on("click", ".delete-item-btn", function() {
        var itemId = $(this).data("item-id");
        var itemName = $(this).data("item-name");

        if (!confirm("상품 '" + itemName + "'을(를) 삭제하시겠습니까?")) {
          return;
        }

        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        if (!token) {
          token = $("meta[name='_csrf'][content]").attr("content");
        }
        if (!header) {
          header = $("meta[name='_csrf_header'][content]").attr("content");
        }

        $.ajax({
          url: "/admin/items",
          type: "DELETE",
          data: "itemIds=" + itemId,
          contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
          beforeSend: function(xhr) {
            if (header && token) {
              xhr.setRequestHeader(header, token);
            }
          },
          success: function(response) {
            alert("상품이 성공적으로 삭제되었습니다.");
            location.reload();
          },
          error: function(xhr, status, error) {
            var errorMessage = "삭제 중 오류가 발생했습니다.";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            } else if (xhr.responseText) {
              errorMessage = xhr.responseText;
            }
            alert(errorMessage);
          }
        });
      });

      // 초기 삭제 버튼 상태 설정
      updateDeleteButtonState();
    }

    // 페이지 이동 함수
    function page(page){
      var searchDateType = $("#searchDateType").val();
      var searchSellStatus = $("#searchSellStatus").val();
      var searchBy = $("#searchBy").val();
      var searchQuery = $("#searchQuery").val();

      location.href="/admin/items/" + page + "?searchDateType=" + searchDateType
              + "&searchSellStatus=" + searchSellStatus
              + "&searchBy=" + searchBy
              + "&searchQuery=" + searchQuery;
    }
  </script>
</th:block>
</body>
</html>